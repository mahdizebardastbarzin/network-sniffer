# ---------------------------------------------------
# report_builder.py
# Advanced Network Sniffer â€“ HTML & JSON Report Builder
# By Mahdi Zebardast Barzin
# ---------------------------------------------------

import json
import os

# -------------------------------------------------------------
# ğŸ‡¬ğŸ‡§ Load analysis data from JSON file
# ğŸ‡®ğŸ‡· Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†ØªØ§ÛŒØ¬ ØªØ­Ù„ÛŒÙ„ Ø§Ø² ÙØ§ÛŒÙ„ JSON
# -------------------------------------------------------------
def load_analysis(json_path="results/analysis.json"):
    if not os.path.exists(json_path):
        raise FileNotFoundError("âŒ analysis.json not found!")
    
    with open(json_path, "r", encoding="utf-8") as f:
        data = json.load(f)
    
    return data

# -------------------------------------------------------------
# ğŸ‡¬ğŸ‡§ Load HTML template for report
# ğŸ‡®ğŸ‡· Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù‚Ø§Ù„Ø¨ HTML Ø¨Ø±Ø§ÛŒ Ú¯Ø²Ø§Ø±Ø´
# -------------------------------------------------------------
def load_template(template_path="templates/report_template.html"):
    if not os.path.exists(template_path):
        raise FileNotFoundError("âŒ report_template.html not found!")

    with open(template_path, "r", encoding="utf-8") as f:
        html_template = f.read()
    
    return html_template

# -------------------------------------------------------------
# ğŸ‡¬ğŸ‡§ Build HTML report and save to results folder
# ğŸ‡®ğŸ‡· Ø³Ø§Ø®Øª Ú¯Ø²Ø§Ø±Ø´ HTML Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ù¾ÙˆØ´Ù‡ results
# -------------------------------------------------------------
def build_html_report(analysis_data, output_path="results/traffic_report.html"):
    template = load_template()
    
    # Replace placeholders with real data
    html_content = template.replace("{{total_packets}}", str(analysis_data["total_packets"]))
    
    # Protocol usage
    protocol_html = ""
    for proto, count in analysis_data["protocol_usage"].items():
        protocol_html += f"<li>{proto}: {count}</li>"
    html_content = html_content.replace("{{protocol_usage}}", protocol_html)
    
    # Top Source IPs
    src_html = ""
    for ip, count in analysis_data["top_source_ips"]:
        src_html += f"<li>{ip}: {count}</li>"
    html_content = html_content.replace("{{top_source_ips}}", src_html)
    
    # Top Destination IPs
    dst_html = ""
    for ip, count in analysis_data["top_destination_ips"]:
        dst_html += f"<li>{ip}: {count}</li>"
    html_content = html_content.replace("{{top_destination_ips}}", dst_html)
    
    # Top Ports
    port_html = ""
    for port, count in analysis_data["top_ports"]:
        port_html += f"<li>{port}: {count}</li>"
    html_content = html_content.replace("{{top_ports}}", port_html)
    
    # Create results folder if not exists
    os.makedirs("results", exist_ok=True)
    
    with open(output_path, "w", encoding="utf-8") as f:
        f.write(html_content)
    
    print(f"ğŸ“ HTML report saved: {output_path}")

# -------------------------------------------------------------
# ğŸ‡¬ğŸ‡§ Save analysis as JSON for backup
# ğŸ‡®ğŸ‡· Ø°Ø®ÛŒØ±Ù‡ Ù†ØªØ§ÛŒØ¬ ØªØ­Ù„ÛŒÙ„ Ø¨Ù‡ ØµÙˆØ±Øª JSON Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù†Ø³Ø®Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†
# -------------------------------------------------------------
def save_json_report(analysis_data, output_path="results/traffic_report.json"):
    os.makedirs("results", exist_ok=True)
    
    with open(output_path, "w", encoding="utf-8") as f:
        json.dump(analysis_data, f, indent=4, ensure_ascii=False)
    
    print(f"ğŸ“ JSON report saved: {output_path}")


# -------------------------------------------------------------
# ğŸ‡¬ğŸ‡§ Script entry point for standalone usage
# ğŸ‡®ğŸ‡· Ù†Ù‚Ø·Ù‡ Ø´Ø±ÙˆØ¹ Ø§Ø¬Ø±Ø§ÛŒ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª
# -------------------------------------------------------------
if __name__ == "__main__":
    print("ğŸ” Loading analysis data...")
    data = load_analysis()
    
    print("ğŸ“„ Building HTML report...")
    build_html_report(data)
    
    print("ğŸ’¾ Saving JSON report backup...")
    save_json_report(data)
    
    print("âœ¨ Report generation completed!")
