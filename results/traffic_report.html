# ---------------------------------------------------
# report_builder.py
# Advanced Network Sniffer â€“ HTML & JSON Report Builder
# By Mahdi Zebardast Barzin
# ---------------------------------------------------

import json
import os

# -------------------------------------------------------------
# ğŸ‡¬ğŸ‡§ Load analysis data from JSON file
# ğŸ‡®ğŸ‡· Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†ØªØ§ÛŒØ¬ ØªØ­Ù„ÛŒÙ„ Ø§Ø² ÙØ§ÛŒÙ„ JSON
# -------------------------------------------------------------
def load_analysis(json_path="results/analysis.json"):
    if not os.path.exists(json_path):
        raise FileNotFoundError("âŒ analysis.json not found!")
    
    with open(json_path, "r", encoding="utf-8") as f:
        data = json.load(f)
    
    return data

# -------------------------------------------------------------
# ğŸ‡¬ğŸ‡§ Load HTML template for report
# ğŸ‡®ğŸ‡· Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù‚Ø§Ù„Ø¨ HTML Ø¨Ø±Ø§ÛŒ Ú¯Ø²Ø§Ø±Ø´
# -------------------------------------------------------------
def load_template(template_path="templates/report_template.html"):
    if not os.path.exists(template_path):
        raise FileNotFoundError("âŒ report_template.html not found!")

    with open(template_path, "r", encoding="utf-8") as f:
        html_template = f.read()
    
    return html_template

# -------------------------------------------------------------
# ğŸ‡¬ğŸ‡§ Build HTML report and save to results folder
# ğŸ‡®ğŸ‡· Ø³Ø§Ø®Øª Ú¯Ø²Ø§Ø±Ø´ HTML Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ù¾ÙˆØ´Ù‡ results
# -------------------------------------------------------------
def build_html_report(analysis_data, output_path="results/traffic_report.html"):
    template = load_template()
    
    # Replace placeholders with real data
    html_content = template.replace("1734", str(analysis_data["total_packets"]))
    
    # Protocol usage
    protocol_html = ""
    for proto, count in analysis_data["protocol_usage"].items():
        protocol_html += f"<li>{proto}: {count}</li>"
    html_content = html_content.replace("<li>TCP: 1715</li>
<li>UDP: 17</li>
<li>null: 2</li>
", protocol_html)
    
    # Top Source IPs
    src_html = ""
    for ip, count in analysis_data["top_source_ips"]:
        src_html += f"<li>{ip}: {count}</li>"
    html_content = html_content.replace("<li>62.210.92.65: 940</li>
<li>192.168.1.5: 732</li>
<li>50.7.87.86: 20</li>
<li>50.7.87.82: 18</li>
<li>185.160.60.100: 8</li>
<li>146.75.121.91: 5</li>
<li>142.54.189.110: 4</li>
<li>34.107.243.93: 2</li>
<li>178.22.122.100: 2</li>
<li>50.7.85.221: 1</li>
", src_html)
    
    # Top Destination IPs
    dst_html = ""
    for ip, count in analysis_data["top_destination_ips"]:
        dst_html += f"<li>{ip}: {count}</li>"
    html_content = html_content.replace("<li>192.168.1.5: 1000</li>
<li>62.210.92.65: 660</li>
<li>50.7.87.86: 20</li>
<li>50.7.87.82: 16</li>
<li>224.0.0.251: 9</li>
<li>185.160.60.100: 7</li>
<li>146.75.121.91: 5</li>
<li>34.107.243.93: 4</li>
<li>239.255.255.250: 4</li>
<li>142.54.189.110: 4</li>
", dst_html)
    
    # Top Ports
    port_html = ""
    for port, count in analysis_data["top_ports"]:
        port_html += f"<li>{port}: {count}</li>"
    html_content = html_content.replace("<li>48463: 1600</li>
<li>6605: 1230</li>
<li>3670: 171</li>
<li>443: 100</li>
<li>7944: 77</li>
<li>5664: 57</li>
<li>6767: 40</li>
<li>3069: 40</li>
<li>9584: 30</li>
<li>10738: 25</li>
", port_html)
    
    # Create results folder if not exists
    os.makedirs("results", exist_ok=True)
    
    with open(output_path, "w", encoding="utf-8") as f:
        f.write(html_content)
    
    print(f"ğŸ“ HTML report saved: {output_path}")

# -------------------------------------------------------------
# ğŸ‡¬ğŸ‡§ Save analysis as JSON for backup
# ğŸ‡®ğŸ‡· Ø°Ø®ÛŒØ±Ù‡ Ù†ØªØ§ÛŒØ¬ ØªØ­Ù„ÛŒÙ„ Ø¨Ù‡ ØµÙˆØ±Øª JSON Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù†Ø³Ø®Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†
# -------------------------------------------------------------
def save_json_report(analysis_data, output_path="results/traffic_report.json"):
    os.makedirs("results", exist_ok=True)
    
    with open(output_path, "w", encoding="utf-8") as f:
        json.dump(analysis_data, f, indent=4, ensure_ascii=False)
    
    print(f"ğŸ“ JSON report saved: {output_path}")


# -------------------------------------------------------------
# ğŸ‡¬ğŸ‡§ Script entry point for standalone usage
# ğŸ‡®ğŸ‡· Ù†Ù‚Ø·Ù‡ Ø´Ø±ÙˆØ¹ Ø§Ø¬Ø±Ø§ÛŒ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª
# -------------------------------------------------------------
if __name__ == "__main__":
    print("ğŸ” Loading analysis data...")
    data = load_analysis()
    
    print("ğŸ“„ Building HTML report...")
    build_html_report(data)
    
    print("ğŸ’¾ Saving JSON report backup...")
    save_json_report(data)
    
    print("âœ¨ Report generation completed!")
